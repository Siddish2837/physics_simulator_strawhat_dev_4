<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Simulation â€” AI Engine Demo</title>
    <link rel="stylesheet" href="simulation-engine/ui-overlay.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: #0a0a1a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 22px;
            color: #00f5ff;
            margin-bottom: 16px;
            text-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-bottom: 20px;
        }

        .controls {
            max-width: 900px;
            margin: 0 auto 16px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .controls textarea {
            flex: 1;
            min-width: 300px;
            height: 50px;
            padding: 12px;
            background: #12122a;
            color: #eee;
            border: 1px solid #1a1a3e;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            resize: none;
        }

        .controls textarea:focus {
            outline: none;
            border-color: #00f5ff;
        }

        .btn-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 18px;
            font-size: 12px;
            font-family: inherit;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .btn-go {
            background: #00f5ff;
            color: #0a0a1a;
            font-weight: 700;
        }

        .btn-preset {
            background: #1a1a3e;
            color: #aaa;
        }

        .btn-preset:hover {
            background: #2a2a5e;
            color: #fff;
        }

        .btn-ctrl {
            background: #222;
            color: #888;
            font-size: 16px;
            padding: 8px 14px;
        }

        .btn-ctrl:hover {
            color: #fff;
        }

        .canvas-wrap {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        #simCanvas {
            width: 100%;
            border-radius: 10px;
        }

        .status-bar {
            max-width: 900px;
            margin: 10px auto 0;
            font-size: 11px;
            color: #555;
            display: flex;
            justify-content: space-between;
        }

        .presets {
            max-width: 900px;
            margin: 0 auto 10px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <h1>âš›ï¸ Physics Simulation Engine</h1>
    <div id="auth-links"
        style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; align-items: center;">
        <div id="user-button"></div>
        <div id="sign-in-link"></div>
    </div>
    <p class="subtitle">Type a physics problem or pick a preset â€” watch it simulate instantly</p>

    <div class="presets">
        <button class="btn-preset" data-preset="projectile">ğŸ€ Projectile</button>
        <button class="btn-preset" data-preset="linear">ğŸš— Linear Motion</button>
        <button class="btn-preset" data-preset="circular">ğŸ”„ Circular Motion</button>
        <button class="btn-preset" data-preset="wave">ğŸŒŠ Wave</button>
        <button class="btn-preset" data-preset="optics">ğŸ” Optics (Lens)</button>
        <button class="btn-preset" data-preset="optics_ray">ğŸ’¡ Refraction</button>
        <button class="btn-preset" data-preset="energy">âš¡ Energy</button>
        <button class="btn-preset" data-preset="collision">ğŸ’¥ Collision</button>
        <button class="btn-preset" data-preset="electric">ğŸ”Œ Electric Field</button>
        <button class="btn-preset" data-preset="magnetic">ğŸ§² Magnetic Field</button>
        <button class="btn-preset" data-preset="friction">ğŸ§± Friction</button>
        <button class="btn-preset" data-preset="incline">â›°ï¸ Incline</button>
        <button class="btn-preset" data-preset="fluid">ğŸŒŠ Fluid Flow</button>
        <button class="btn-preset" data-preset="lift_preset">âœˆï¸ Lift</button>
        <button class="btn-preset" data-preset="mag_advanced">âš¡ Lorentz</button>
        <button class="btn-preset" data-preset="spring">ğŸ”© Spring</button>
        <button class="btn-preset" data-preset="pulley">âš™ï¸ Pulley</button>
        <button class="btn-preset" data-preset="gravity">ğŸª Orbits</button>
        <button class="btn-preset" data-preset="thermo">ğŸŒ¡ï¸ Thermo</button>
        <button class="btn-preset" data-preset="elasticity">ğŸ“ Elasticity</button>
    </div>

    <div class="presets">
        <strong style="color:#888; font-size:11px; margin-right:8px;">Composite:</strong>
        <button class="btn-preset" data-preset="proj_incline">ğŸ¯ Projectile+Incline</button>
        <button class="btn-preset" data-preset="spring_fric">ğŸ”© Spring+Friction</button>
        <button class="btn-preset" data-preset="pulley_spr">âš™ï¸ Pulley+Spring</button>
        <button class="btn-preset" data-preset="multi_pulley">âš™ï¸ Multi-Pulley</button>
        <button class="btn-preset" data-preset="pulley_multi_mass">âš™ï¸ Multi-Mass Pulley</button>
    </div>

    <div class="controls">
        <textarea id="input"
            placeholder="A ball is thrown at 25 m/s at 60 degrees from a 5m height...">A ball is thrown at 25 m/s at 60 degrees from a 5 meter building</textarea>
        <div class="btn-row">
            <button class="btn-go" id="runBtn">â–¶ Simulate</button>
            <button class="btn-ctrl" id="pauseBtn" title="Pause/Play">â¸</button>
            <button class="btn-ctrl" id="resetBtn" title="Reset">â†º</button>
            <div class="divider" style="width:1px;height:24px;background:#333;margin:0 4px;"></div>
            <button class="btn-ctrl" id="zoomOutBtn" title="Zoom Out">âˆ’</button>
            <button class="btn-ctrl" id="zoomInBtn" title="Zoom In">+</button>
            <button class="btn-ctrl" id="recenterBtn" title="Recenter View">âŒ–</button>
            <select id="unitSelect"
                style="background:#12122a; color:#aaa; border:1px solid #333; border-radius:4px; padding:4px; font-family:inherit; font-size:11px;">
                <option value="m" selected>Scale: Meters (m)</option>
                <option value="cm">Centimeters (cm)</option>
                <option value="mm">Millimeters (mm)</option>
                <option value="km">Kilometers (km)</option>
            </select>
        </div>
    </div>

    <div class="canvas-wrap">
        <canvas id="simCanvas" width="900" height="600"></canvas>
    </div>
    <div class="status-bar">
        <span id="statusTopic">Topic: â€”</span>
        <span id="statusInfo">Ready</span>
    </div>

    <script type="module">
        const CLERK_PUBLISHABLE_KEY = 'pk_test_ZGVjZW50LXF1YWdnYS04MC5jbGVyay5hY2NvdW50cy5kZXYk';

        // Wait for Clerk to load
        async function initClerk() {
            if (window.Clerk) {
                await window.Clerk.load();

                const userButtonDiv = document.getElementById('user-button');
                const signInDiv = document.getElementById('sign-in-link');

                if (window.Clerk.user) {
                    window.Clerk.mountUserButton(userButtonDiv);
                    signInDiv.innerHTML = '';
                } else {
                    userButtonDiv.innerHTML = '';
                    const signInButton = document.createElement('button');
                    signInButton.textContent = 'Sign In';
                    signInButton.className = 'btn-preset';
                    signInButton.style.color = '#fff';
                    signInButton.style.background = '#00f5ff22';
                    signInButton.onclick = () => window.Clerk.openSignIn();
                    signInDiv.appendChild(signInButton);
                }
            }
        }

        // Add Clerk script dynamically
        const script = document.createElement('script');
        script.setAttribute('data-clerk-publishable-key', CLERK_PUBLISHABLE_KEY);
        script.async = true;
        script.src = `https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js`;
        script.crossOrigin = 'anonymous';
        script.onload = initClerk;
        document.body.appendChild(script);

        import { extractParameters } from './ai.js';
        import { normalizeParams } from './parser.js';
        import { attachComputedValues } from './formula-engine.js';
        import {
            initSimulation, load, start, stop, reset, getObjects,
            setZoom, getCamera, resetView, setUnit, drawRoundRect
        } from './simulation-engine/simulation-core.js';
        import { initTooltip } from './simulation-engine/tooltip.js';

        import { simulateLinearMotion } from './simulation-engine/motion-sim.js';
        import { simulateProjectile } from './simulation-engine/projectile-sim.js';
        import { simulateCircularMotion } from './simulation-engine/circular-sim.js';
        import { simulateWave } from './simulation-engine/waves-sim.js';
        import { simulateOptics } from './simulation-engine/optics-sim.js';
        import { simulateEnergy } from './simulation-engine/energy-sim.js';
        import { simulateCollisions } from './simulation-engine/collisions-sim.js';
        import { simulateFields } from './simulation-engine/fields-sim.js';

        import { simulateFriction } from './simulation-engine/friction-sim.js';
        import { simulateIncline } from './simulation-engine/incline-sim.js';
        import { simulateFluid } from './simulation-engine/fluid-sim.js';
        import { simulateLift } from './simulation-engine/lift-sim.js';
        import { simulateMagnetismAdvanced } from './simulation-engine/magnetism-advanced-sim.js';
        import { simulateSpring } from './simulation-engine/spring-sim.js';
        import { simulatePulley } from './simulation-engine/pulley-sim.js';
        import { simulateGravity } from './simulation-engine/gravity-sim.js';
        import { simulateThermo } from './simulation-engine/thermo-sim.js';
        import { simulateElasticity } from './simulation-engine/elasticity-sim.js';

        // Composite simulations
        import { simulateProjectileIncline } from './simulation-engine/projectile-incline-sim.js';
        import { simulateSpringFriction } from './simulation-engine/spring-friction-sim.js';
        import { simulatePulleySpring } from './simulation-engine/pulley-spring-sim.js';
        import { simulateMultiPulley } from './simulation-engine/multi-pulley-sim.js';

        // Sim map
        const SIM_MAP = {
            linear_motion: simulateLinearMotion,
            projectile: simulateProjectile,
            circular_motion: simulateCircularMotion,
            waves: simulateWave,
            optics: simulateOptics,
            energy: simulateEnergy,
            collision: simulateCollisions,
            electricity: simulateFields,
            magnetism: simulateFields,
            friction: simulateFriction,
            inclined_plane: simulateIncline,
            fluid_dynamics: simulateFluid,
            lift: simulateLift,
            magnetism_advanced: simulateMagnetismAdvanced,
            spring: simulateSpring,
            pulley: simulatePulley,
            gravitation: simulateGravity,
            thermodynamics: simulateThermo,
            elasticity: simulateElasticity,
            projectile_incline: simulateProjectileIncline,
            spring_friction: simulateSpringFriction,
            pulley_spring: simulatePulleySpring,
            multi_pulley: simulateMultiPulley
        };

        // Presets (offline fallback)
        const PRESETS = {
            projectile: {
                topic: 'projectile', sub_topic: 'angled_launch', object: 'Ball',
                initial_velocity: { magnitude: 25, direction: '60Â° above horizontal' },
                launch_angle: 60, launch_height: 5, gravity: 9.8, mass: 2,
                initial_position: { x0: 0, y0: 5, z0: 0 },
                formulas: { equations: ['R = vâ‚€Â²sin(2Î¸)/g', 'H = vâ‚€Â²sinÂ²(Î¸)/2g', 'T = 2vâ‚€sin(Î¸)/g'], calculations: { range: 55.2, max_height: 29.0, time_of_flight: 4.42 } }
            },
            linear: {
                topic: 'linear_motion', sub_topic: 'uniform_acceleration', object: 'Car',
                initial_position: { x0: 0, y0: 0, z0: 0 },
                initial_velocity: { magnitude: 5, direction: 'right' },
                acceleration: { value: 2, direction: 'right', type: 'uniform' },
                mass: 1000, gravity: 9.8,
                formulas: { equations: ['x = xâ‚€+vâ‚€t+Â½atÂ²', 'v = vâ‚€+at'], calculations: { final_velocity_5s: 15, displacement_5s: 50 } }
            },
            circular: {
                topic: 'circular_motion', sub_topic: 'uniform', object: 'Satellite',
                radius: 100, angular_velocity: 1.5, mass: 5, gravity: 9.8,
                initial_position: { x0: 0, y0: 0, z0: 0 },
                initial_velocity: { magnitude: 150, direction: 'tangent' },
                formulas: { equations: ['v=Ï‰r', 'ac=vÂ²/r', 'Fc=mvÂ²/r'], calculations: { speed: 150, centripetal_acceleration: 225, period: 4.19 } }
            },
            wave: {
                topic: 'waves', sub_topic: 'transverse', object: 'Wave',
                waves: { wavelength: 2, frequency: 3, amplitude: 1.5, speed: 6, type: 'transverse', period: 0.33, phase: 0, phenomena: null, doppler: { source_velocity: null, observer_velocity: null } },
                gravity: 9.8, mass: 1, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['v = fÎ»', 'T = 1/f', 'y = AÂ·sin(2Ï€ftâˆ’kx)'], calculations: { wave_speed: 6, period: 0.333 } }
            },
            optics: {
                topic: 'optics', sub_topic: 'lens', object: 'Light',
                optics: { type: 'lens', focal_length: 60, object_distance: 120, image_distance: 120, angles: { incidence: null, reflection: null, refraction: null }, indices: { n1: null, n2: null } },
                gravity: 9.8, mass: 1, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['1/f = 1/dâ‚’ + 1/dáµ¢', 'M = âˆ’dáµ¢/dâ‚’'], calculations: { magnification: -1, image_distance: 120 } }
            },
            optics_ray: {
                topic: 'optics', sub_topic: 'refraction', object: 'Light Ray',
                optics: { type: 'refraction', focal_length: null, object_distance: null, image_distance: null, angles: { incidence: 45, reflection: 45, refraction: 28.1 }, indices: { n1: 1.0, n2: 1.5 } },
                gravity: 9.8, mass: 1, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['nâ‚sin(Î¸â‚) = nâ‚‚sin(Î¸â‚‚)'], calculations: { angle_of_refraction: 28.1 } }
            },
            energy: {
                topic: 'energy', sub_topic: 'conservation', object: 'Ball',
                mass: 2, gravity: 9.8, launch_height: 40,
                initial_velocity: { magnitude: 0, direction: 'none' },
                initial_position: { x0: 0, y0: 40, z0: 0 },
                energy: { kinetic: 0, potential_gravitational: 784, work_done: null, power: null, spring_constant: null },
                formulas: { equations: ['KE=Â½mvÂ²', 'PE=mgh', 'E=KE+PE'], calculations: { total_energy: 784, potential_energy: 784, kinetic_energy: 0 } }
            },
            collision: {
                topic: 'collision', sub_topic: 'elastic', object: 'Objects',
                collision: { type: 'elastic', masses: [3, 1], velocities_before: [4, -2], velocities_after: [1, 7], impulse: null },
                mass: 1, gravity: 9.8, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['p=mv', 'mâ‚uâ‚+mâ‚‚uâ‚‚=mâ‚vâ‚+mâ‚‚vâ‚‚'], calculations: { momentum_before: 10, momentum_after: 10 } }
            },
            electric: {
                topic: 'electricity', sub_topic: 'electric_field', object: 'Charge',
                electricity: { charge: 5, electric_field: 100, voltage: null, current: null, resistance: null },
                mass: 1, gravity: 9.8, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['E = kQ/rÂ²', 'F = qE'], calculations: { field_strength: 100 } }
            },
            magnetic: {
                topic: 'magnetism', sub_topic: 'magnetic_field', object: 'Wire',
                magnetism: { magnetic_field: 0.5, force_on_charge: null, induced_emf: null },
                mass: 1, gravity: 9.8, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['B = Î¼â‚€I/(2Ï€r)', 'F = qvB'], calculations: { magnetic_field: 0.5 } }
            },
            friction: {
                topic: 'friction', sub_topic: 'kinetic', object: 'Block',
                mass: 5, gravity: 9.8,
                friction: { static_coefficient: 0.5, kinetic_coefficient: 0.3 },
                forces: { applied: 30 },
                initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['f_s = Î¼_sÂ·N', 'f_k = Î¼_kÂ·N'], calculations: { normal_force: 49, kinetic_friction: 14.7 } }
            },
            incline: {
                topic: 'inclined_plane', sub_topic: 'sliding', object: 'Block',
                mass: 5, gravity: 9.8, launch_angle: 30,
                incline: { angle: 30 },
                friction: { kinetic_coefficient: 0.1 },
                initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['Fâˆ¥=mgÂ·sin(Î¸)', 'N=mgÂ·cos(Î¸)'], calculations: { parallel_force: 24.5, normal_force: 42.4 } }
            },
            fluid: {
                topic: 'fluid_dynamics', sub_topic: 'bernoulli', object: 'Fluid',
                fluid: { density: 1000, area1: 0.05, area2: 0.02, velocity1: 2, pressure1: 101325, height1: 0, height2: 0 },
                gravity: 9.8, mass: 1, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['Aâ‚vâ‚=Aâ‚‚vâ‚‚', 'P+Â½ÏvÂ²+Ïgh=const'], calculations: { velocity2: 5 } }
            },
            lift_preset: {
                topic: 'lift', sub_topic: 'bernoulli_lift', object: 'Wing',
                fluid: { density: 1.225 },
                lift: { velocity_top: 60, velocity_bottom: 45, wing_area: 20 },
                gravity: 9.8, mass: 1, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['F_lift=Î”PÃ—A', 'Î”P=Â½Ï(v_bÂ²âˆ’v_tÂ²)'], calculations: { lift_force: 16538 } }
            },
            mag_advanced: {
                topic: 'magnetism_advanced', sub_topic: 'lorentz_force', object: 'Electron',
                magnetism: { magnetic_field: 0.5 },
                electricity: { charge: 1.6e-19 },
                mass: 9.11e-31,
                initial_velocity: { magnitude: 1e6, direction: 'perpendicular' },
                initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['F=qvB', 'r=mv/qB'], calculations: { lorentz_force: 8e-14 } }
            },
            spring: {
                topic: 'spring', sub_topic: 'shm', object: 'Mass',
                mass: 2, gravity: 9.8,
                spring: { constant: 50, displacement: 1.5, damping: 0 },
                energy: { spring_constant: 50 },
                initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['F=-kx', 'PE=Â½kxÂ²', 'Ï‰=âˆš(k/m)'], calculations: { period: 1.26 } }
            },
            pulley: {
                topic: 'pulley', sub_topic: 'atwood', object: 'Pulley System',
                pulley: { mass1: 10, mass2: 5, spring_coupled: false },
                gravity: 9.8, mass: 1, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['a=(mâ‚âˆ’mâ‚‚)g/(mâ‚+mâ‚‚)', 'T=2mâ‚mâ‚‚g/(mâ‚+mâ‚‚)'], calculations: { acceleration: 3.27, tension: 65.3 } }
            },
            gravity: {
                topic: 'gravitation', sub_topic: 'orbital', object: 'Planet',
                gravitation: { central_mass: 1.989e30, orbital_radius: 1.496e11 },
                mass: 5.972e24, gravity: 9.8, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['F=GMm/rÂ²', 'v=âˆš(GM/r)'], calculations: { orbital_velocity: 29783 } }
            },
            thermo: {
                topic: 'thermodynamics', sub_topic: 'ideal_gas', object: 'Gas',
                thermodynamics: { temperature_initial: 300, temperature_final: 500, pressure: 101325, moles: 1, specific_heat: 1000 },
                mass: 1, gravity: 9.8, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['PV=nRT', 'Q=mcÎ”T'], calculations: { heat_transfer: 200000 } }
            },
            elasticity: {
                topic: 'elasticity', sub_topic: 'youngs_modulus', object: 'Steel Bar',
                forces: { applied: 5000 },
                elasticity: { area: 0.01, original_length: 2, youngs_modulus: 2e11 },
                mass: 1, gravity: 9.8, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['Ïƒ=F/A', 'Îµ=Ïƒ/E', 'Î”L=ÎµLâ‚€'], calculations: { stress: 500000, strain: 2.5e-6 } }
            },
            proj_incline: {
                topic: 'projectile_incline', sub_topic: 'bounce', object: 'Ball',
                mass: 1, gravity: 9.8,
                initial_velocity: { magnitude: 20 },
                launch_angle: 25,
                incline: { angle: 45 },
                collision: { coefficient_of_restitution: 0.7 },
                initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['vâ‚€â‚“=vâ‚€Â·cos(Î¸)', 'Bounce: v\'=eÂ·v'], calculations: { initial_vx: 18.1, initial_vy: 8.5 } }
            },
            spring_fric: {
                topic: 'spring_friction', sub_topic: 'damped_oscillation', object: 'Block',
                mass: 2, gravity: 9.8,
                spring: { constant: 50, displacement: 1.5 },
                friction: { kinetic_coefficient: 0.15 },
                initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['Ï‰â‚€=âˆš(k/m)', 'f_friction=Î¼_kÂ·mg'], calculations: { natural_frequency: 5, friction_force: 2.94 } }
            },
            pulley_spr: {
                topic: 'pulley_spring', sub_topic: 'oscillating_masses', object: 'Atwood+Spring',
                mass: 1, gravity: 9.8,
                pulley: { mass1: 10, mass2: 5, spring_coupled: true, spring_constant: 20 },
                initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['m_eff=(mâ‚Â·mâ‚‚)/(mâ‚+mâ‚‚)', 'T=2Ï€/Ï‰'], calculations: { effective_mass: 3.33, period: 2.57 } }
            },
            pulley_multi_mass: {
                topic: 'pulley', sub_topic: 'atwood_multi', object: 'Pulley System',
                pulley: { masses_left: [5, 3, 2], masses_right: [4, 4], spring_coupled: false },
                gravity: 9.8, mass: 1, initial_position: { x0: 0, y0: 0, z0: 0 },
                formulas: { equations: ['a=(Î£mâ‚âˆ’Î£mâ‚‚)g/(Î£mâ‚+Î£mâ‚‚)'], calculations: { total_m1: 10, total_m2: 8, acceleration: 1.09 } }
            }
        };

        // Init
        const { canvas } = initSimulation('simCanvas');
        initTooltip(canvas, getObjects);
        let paused = false;

        function runSimulation(rawParams) {
            const clean = normalizeParams(rawParams);
            const final = attachComputedValues(clean);
            const simFn = SIM_MAP[final.topic];

            document.getElementById('statusTopic').textContent = `Topic: ${final.topic} / ${final.sub_topic || 'â€”'}`;

            if (!simFn) {
                document.getElementById('statusInfo').textContent = `No simulation for topic "${final.topic}"`;
                return;
            }

            load(simFn, final);
            paused = false;
            document.getElementById('pauseBtn').textContent = 'â¸';
            document.getElementById('statusInfo').textContent = 'ğŸŸ¢ Running';
        }

        // Preset buttons
        document.querySelectorAll('.btn-preset').forEach(btn => {
            btn.addEventListener('click', () => {
                const key = btn.dataset.preset;
                if (PRESETS[key]) {
                    document.getElementById('statusInfo').textContent = 'ğŸŸ¢ Running (preset)';
                    runSimulation(PRESETS[key]);
                }
            });
        });

        // Unit selector
        document.getElementById('unitSelect').addEventListener('change', (e) => {
            setUnit(e.target.value);
        });

        // ======= INPUT VALIDATION =======
        const PHYSICS_KEYWORDS = [
            'velocity', 'speed', 'acceleration', 'force', 'mass', 'gravity',
            'projectile', 'throw', 'thrown', 'launch', 'ball', 'bullet', 'fired',
            'wave', 'frequency', 'amplitude', 'wavelength', 'oscillat', 'hertz',
            'lens', 'mirror', 'refract', 'reflect', 'snell', 'optic', 'focal', 'prism', 'light', 'ray',
            'circular', 'orbit', 'rotation', 'angular', 'centripetal', 'revolv', 'radius',
            'energy', 'kinetic', 'potential', 'joule', 'watt', 'power', 'work',
            'collision', 'elastic', 'inelastic', 'momentum', 'impulse',
            'electric', 'charge', 'voltage', 'current', 'ohm', 'coulomb', 'capacitor', 'resistor',
            'magnet', 'magnetic', 'tesla', 'inducto', 'solenoid', 'wire',
            'linear', 'motion', 'car', 'vehicle', 'train', 'object',
            'newton', 'friction', 'drag', 'tension', 'spring', 'hooke',
            'pendulum', 'simple harmonic', 'shm',
            'angle', 'degree', 'm/s', 'km/h', 'kg', 'meter', 'displacement',
            'height', 'distance', 'fall', 'drop', 'rise', 'incline', 'slope',
            'pressure', 'density', 'buoyancy', 'fluid', 'torque', 'lever',
            'friction', 'coefficient', 'rough', 'smooth', 'surface', 'sliding', 'static',
            'incline', 'slope', 'ramp', 'hill',
            'bernoulli', 'pipe', 'flow', 'continuity',
            'lift', 'wing', 'airfoil', 'aerodynamic', 'airplane', 'fly',
            'lorentz', 'cyclotron', 'electron', 'proton',
            'spring', 'hooke', 'oscillation', 'elastic', 'restoring',
            'pulley', 'rope', 'atwood', 'tension',
            'orbit', 'planet', 'satellite', 'solar', 'gravitation', 'kepler',
            'temperature', 'heat', 'gas', 'mole', 'ideal gas', 'piston', 'thermal',
            'stress', 'strain', 'modulus', 'deformation', 'stretch', 'young',
        ];

        function isPhysicsInput(text) {
            const lower = text.toLowerCase();
            return PHYSICS_KEYWORDS.some(kw => lower.includes(kw));
        }

        function detectPreset(text) {
            const input = text.toLowerCase();

            // Composite topics â€” check FIRST (highest priority)
            if ((input.includes('projectile') || input.includes('throw') || input.includes('ball')) &&
                (input.includes('incline') || input.includes('slope') || input.includes('ramp')) &&
                (input.includes('bounce') || input.includes('hit') || input.includes('onto'))) return 'proj_incline';

            if ((input.includes('spring') || input.includes('oscillat')) &&
                (input.includes('friction') || input.includes('damp'))) return 'spring_fric';

            if ((input.includes('pulley') || input.includes('atwood')) &&
                (input.includes('spring'))) return 'pulley_spr';

            // Single topics
            if ((input.includes('wave') && !input.includes('microwave')) || input.includes('frequency') || input.includes('amplitude') || input.includes('wavelength')) return 'wave';
            if (input.includes('lens') || input.includes('mirror') || input.includes('focal')) return 'optics';
            if (input.includes('refract') || input.includes('snell') || input.includes('prism')) return 'optics_ray';
            if (input.includes('collision') || input.includes('inelastic') || input.includes('momentum')) return 'collision';
            if (input.includes('electric') || input.includes('charge') || input.includes('coulomb') || input.includes('voltage')) return 'electric';

            // New topics â€” check BEFORE projectile/energy (which catch generic words like 'angle', 'energy')
            if (input.includes('spring') || input.includes('hooke') || input.includes('oscillat') || input.includes('shm') || input.includes('simple harmonic')) return 'spring';
            if (input.includes('incline') || input.includes('slope') || input.includes('ramp')) return 'incline';
            if ((input.includes('friction') || input.includes('rough') || input.includes('coefficient')) && !input.includes('frictionless')) return 'friction';
            if (input.includes('pulley') || input.includes('atwood')) return 'pulley';
            if (input.includes('bernoulli') || input.includes('pipe') || input.includes('flow') || input.includes('continuity')) return 'fluid';
            if (input.includes('lift') || input.includes('wing') || input.includes('airfoil') || input.includes('airplane')) return 'lift_preset';
            if (input.includes('lorentz') || input.includes('cyclotron')) return 'mag_advanced';
            if (input.includes('orbit') || input.includes('planet') || input.includes('solar') || input.includes('kepler')) return 'gravity';
            if (input.includes('temperature') || input.includes('heat') || input.includes('gas law') || input.includes('piston') || input.includes('thermal')) return 'thermo';
            if (input.includes('stress') || input.includes('strain') || input.includes('modulus') || input.includes('young') || input.includes('stretch')) return 'elasticity';

            // Generic matches after specific ones
            if (input.includes('circular') || input.includes('angular') || input.includes('revolv') || input.includes('centripetal')) return 'circular';
            if (input.includes('energy') || input.includes('kinetic') || input.includes('potential') || input.includes('joule')) return 'energy';
            if (input.includes('magnet') || input.includes('tesla') || input.includes('solenoid')) return 'magnetic';
            if (input.includes('linear') && input.includes('motion')) return 'linear';
            if ((input.includes('car') || input.includes('vehicle') || input.includes('train')) && (input.includes('accelerat') || input.includes('speed') || input.includes('velocity'))) return 'linear';
            if (input.includes('throw') || input.includes('thrown') || input.includes('launch') || input.includes('projectile') || input.includes('angle') || input.includes('fired')) return 'projectile';
            if (input.includes('fall') || input.includes('drop') || input.includes('height') || input.includes('gravity')) return 'projectile';
            if (input.includes('velocity') || input.includes('speed') || input.includes('acceleration') || input.includes('m/s')) return 'linear';
            return null; // no match
        }

        function showNotPhysicsError(ctx, canvas, inputText) {
            stop();
            // Draw dark background
            const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
            g.addColorStop(0, '#080818');
            g.addColorStop(1, '#0d0d2b');
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Error icon
            ctx.save();
            ctx.font = '48px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ğŸš«', canvas.width / 2, 180);

            // Error message
            ctx.font = 'bold 18px "JetBrains Mono", monospace';
            ctx.fillStyle = '#ff6b6b';
            ctx.fillText('Not a physics problem', canvas.width / 2, 230);

            // User input (truncated)
            ctx.font = '13px "JetBrains Mono", monospace';
            ctx.fillStyle = '#666';
            const display = inputText.length > 50 ? inputText.substring(0, 50) + '...' : inputText;
            ctx.fillText(`"${display}"`, canvas.width / 2, 265);

            // Help text
            ctx.font = '13px "JetBrains Mono", monospace';
            ctx.fillStyle = '#888';
            ctx.fillText('Please enter a physics problem. Examples:', canvas.width / 2, 320);

            // Examples
            const examples = [
                '"A ball is thrown at 20 m/s at 45 degrees"',
                '"A car accelerates from rest at 3 m/sÂ²"',
                '"A wave with frequency 5 Hz and wavelength 2m"',
                '"Two objects collide elastically"',
                '"Light passes from air into glass at 30Â°"',
            ];
            ctx.font = '11px "JetBrains Mono", monospace';
            ctx.fillStyle = '#4ecdc4';
            examples.forEach((ex, i) => {
                ctx.fillText(ex, canvas.width / 2, 360 + i * 24);
            });

            // Or use presets
            ctx.font = '12px "JetBrains Mono", monospace';
            ctx.fillStyle = '#ff9f43';
            ctx.fillText('Or click a preset button above â†‘', canvas.width / 2, 510);
            ctx.textAlign = 'left';
            ctx.restore();
        }

        // ======= SIMULATE BUTTON â€” REAL AI ENGINE =======
        document.getElementById('runBtn').addEventListener('click', async () => {
            const inputEl = document.getElementById('input');
            const runBtn = document.getElementById('runBtn');
            const statusInfo = document.getElementById('statusInfo');
            const inputText = inputEl.value.trim();
            const canvasEl = document.getElementById('simCanvas');
            const ctxEl = canvasEl.getContext('2d');

            if (!inputText) { statusInfo.textContent = 'âš ï¸ Enter a physics problem first'; return; }

            // Validate: is this a physics problem?
            if (!isPhysicsInput(inputText)) {
                statusInfo.textContent = 'ğŸš« Not a physics problem â€” try a real physics question';
                showNotPhysicsError(ctxEl, canvasEl, inputText);
                return;
            }

            // Disable button, show loading
            runBtn.disabled = true;
            runBtn.textContent = 'â³ Analyzing...';
            statusInfo.textContent = 'ğŸ”„ Sending to AI engine...';

            // New topics that the AI may misclassify
            const NEW_TOPICS = ['friction', 'inclined_plane', 'fluid_dynamics', 'lift',
                'magnetism_advanced', 'spring', 'pulley', 'gravitation', 'elasticity'];

            // Preset key mapping (some presets have different keys than topic names)
            const TOPIC_TO_PRESET = {
                'friction': 'friction',
                'inclined_plane': 'incline',
                'fluid_dynamics': 'fluid',
                'lift': 'lift_preset',
                'magnetism_advanced': 'mag_advanced',
                'spring': 'spring',
                'pulley': 'pulley',
                'gravitation': 'gravity',
                'elasticity': 'elasticity'
            };

            // Pre-check: does keyword detection match a new topic?
            const keywordMatch = detectPreset(inputText);

            try {
                // ALWAYS call the AI to extract parameters (we need the actual values!)
                const rawParams = await extractParameters(inputText);

                // If keyword detection found a new topic, override the AI's topic choice
                // (AI often misclassifies new topics as 'energy', 'forces', etc.)
                if (keywordMatch && TOPIC_TO_PRESET[rawParams.topic] !== keywordMatch) {
                    // Check if keyword match corresponds to a new topic
                    const matchedTopic = Object.keys(TOPIC_TO_PRESET).find(
                        topic => TOPIC_TO_PRESET[topic] === keywordMatch
                    );

                    if (matchedTopic && NEW_TOPICS.includes(matchedTopic)) {
                        console.log(`[Override] AI said "${rawParams.topic}", keyword detection says "${matchedTopic}"`);
                        rawParams.topic = matchedTopic;
                        statusInfo.textContent = `âœ… Corrected topic to ${matchedTopic}`;
                    }
                }

                // Validate the final topic
                if (!rawParams.topic || !SIM_MAP[rawParams.topic]) {
                    throw new Error(`Unknown topic: ${rawParams.topic}`);
                }

                statusInfo.textContent = 'âœ… AI extracted params â€” starting simulation';
                runSimulation(rawParams);

            } catch (err) {
                console.error('AI Engine error:', err);

                // Fallback: keyword-match to a preset (only if physics)
                const preset = detectPreset(inputText);
                if (preset) {
                    statusInfo.textContent = 'ğŸŸ¡ AI unavailable â€” using keyword match';
                    runSimulation(PRESETS[preset]);
                } else {
                    statusInfo.textContent = 'âŒ Could not determine simulation type';
                    showNotPhysicsError(ctxEl, canvasEl, inputText);
                }
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'â–¶ Simulate';
            }
        });

        // Pause/Play
        document.getElementById('pauseBtn').addEventListener('click', () => {
            if (paused) { start(); paused = false; document.getElementById('pauseBtn').textContent = 'â¸'; document.getElementById('statusInfo').textContent = 'ğŸŸ¢ Running'; }
            else { stop(); paused = true; document.getElementById('pauseBtn').textContent = 'â–¶'; document.getElementById('statusInfo').textContent = 'â¸ Paused'; }
        });

        // Reset
        document.getElementById('resetBtn').addEventListener('click', () => {
            reset();
            paused = false;
            document.getElementById('pauseBtn').textContent = 'â¸';
            document.getElementById('statusInfo').textContent = 'â†º Reset â€” Running';
            start();
        });

        // View Controls

        document.getElementById('zoomInBtn').addEventListener('click', () => {
            const cam = getCamera();
            setZoom(cam.zoom * 1.2);
        });
        document.getElementById('zoomOutBtn').addEventListener('click', () => {
            const cam = getCamera();
            setZoom(cam.zoom / 1.2);
        });
        document.getElementById('recenterBtn').addEventListener('click', () => {
            resetView();
        });
        document.getElementById('unitSelect').addEventListener('change', (e) => {
            setUnit(e.target.value);
            if (paused) { start(); setTimeout(stop, 50); }
        });

        // Auto-run projectile on load
        runSimulation(PRESETS.projectile);
    </script>
</body>

</html>